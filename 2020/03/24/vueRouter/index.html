<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><div class="ball"></div><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span> <span id="busuanzi_container_site_uv">本站总访问量<span id="busuanzi_value_site_uv"></span>次</span></div><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/css/main.css?v=7.1.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2"><link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.1.2",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!1,fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="背景随着单页应用（SPA)的流行，前端路由也得以广泛应用，针对浏览器而言，前端路由有两种实现方式，hash和history。 vue的第三方插件的install函数 先来看一下vue注册第三方插件 1Vue.use(plugin)  这个注册机制就会调用plugin的install方法，来看一下vue-router的install ，src/install.js  1234567891011121"><meta name="keywords" content="VUE,vue-router"><meta property="og:type" content="article"><meta property="og:title" content="vueRouter 浅析"><meta property="og:url" content="http://yoursite.com/2020/03/24/vueRouter/index.html"><meta property="og:site_name" content="sherryJiang . Blog"><meta property="og:description" content="背景随着单页应用（SPA)的流行，前端路由也得以广泛应用，针对浏览器而言，前端路由有两种实现方式，hash和history。 vue的第三方插件的install函数 先来看一下vue注册第三方插件 1Vue.use(plugin)  这个注册机制就会调用plugin的install方法，来看一下vue-router的install ，src/install.js  1234567891011121"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2020-03-24T08:57:59.758Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="vueRouter 浅析"><meta name="twitter:description" content="背景随着单页应用（SPA)的流行，前端路由也得以广泛应用，针对浏览器而言，前端路由有两种实现方式，hash和history。 vue的第三方插件的install函数 先来看一下vue注册第三方插件 1Vue.use(plugin)  这个注册机制就会调用plugin的install方法，来看一下vue-router的install ，src/install.js  1234567891011121"><link rel="alternate" href="/atom.xml" title="sherryJiang . Blog" type="application/atom+xml"><link rel="canonical" href="http://yoursite.com/2020/03/24/vueRouter/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>vueRouter 浅析 | sherryJiang . Blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/SherryJiang1130"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_gray_6d6d6d.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">sherryJiang . Blog</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">F E . 干物妹</h1></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/vueRouter/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="SherryJiang"><meta itemprop="description" content><meta itemprop="image" content="/images/xiaomai.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="sherryJiang . Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">vueRouter 浅析</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-24 16:57:59" itemprop="dateCreated datePublished" datetime="2020-03-24T16:57:59+08:00">2020-03-24</time></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>随着单页应用（SPA)的流行，前端路由也得以广泛应用，针对浏览器而言，前端路由有两种实现方式，hash和history。</p><h2 id="vue的第三方插件的install函数"><a href="#vue的第三方插件的install函数" class="headerlink" title="vue的第三方插件的install函数"></a>vue的第三方插件的install函数</h2><p> 先来看一下vue注册第三方插件<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.use(plugin)</span><br></pre></td></tr></table></figure><p></p><p> 这个注册机制就会调用plugin的install方法，来看一下vue-router的install ，src/install.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    beforeCreate () &#123;</span><br><span class="line">        //首次进入初始化路由</span><br><span class="line">      if (isDef(this.$options.router)) &#123;</span><br><span class="line">          //根组件指向自己</span><br><span class="line">        this._routerRoot = this</span><br><span class="line">        this._router = this.$options.router</span><br><span class="line">        //初次进入对页面进行路由</span><br><span class="line">        this._router.init(this)</span><br><span class="line">        //监控 router数据变化，这里为更新router-view</span><br><span class="line">        Vue.util.defineReactive(this, &apos;_route&apos;, this._router.history.current)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          //为每个组件传递根组件，方便访问router信息</span><br><span class="line">        this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this</span><br><span class="line">      &#125;</span><br><span class="line">      registerInstance(this, this)</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed () &#123;</span><br><span class="line">      registerInstance(this)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">//router访问的是根组件的router对象</span><br><span class="line">  Object.defineProperty(Vue.prototype, &apos;$router&apos;, &#123;</span><br><span class="line">    get () &#123; return this._routerRoot._router &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">//route访问的是根组件的route对象</span><br><span class="line">  Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</span><br><span class="line">    get () &#123; return this._routerRoot._route &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>拓展vue原型，添加全局属性$router和$route，混入beforeCreate和destroyed方法,</p></li><li><p>设置_routerRoot向上传递指向根组件，根组件设置router对象</p></li><li><p>根组件首次进入的时候，初始化路由，将router对象挂载到根组件元素_router上，并且设置劫持数据_route</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> export function install (Vue) &#123;</span><br><span class="line">  if (install.installed &amp;&amp; _Vue === Vue) return //如果已经注册过，直接返回避免重复注册</span><br><span class="line">  install.installed = true</span><br><span class="line">//私有化vue，方便引入</span><br><span class="line">  _Vue = Vue</span><br><span class="line"></span><br><span class="line">  const isDef = v =&gt; v !== undefined</span><br><span class="line"></span><br><span class="line">  const registerInstance = (vm, callVal) =&gt; &#123; // 注册vue-router实例</span><br><span class="line">    let i = vm.$options._parentVnode</span><br><span class="line">    if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</span><br><span class="line">      i(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(&apos;RouterView&apos;, View)</span><br><span class="line">Vue.component(&apos;RouterLink&apos;, Link)</span><br><span class="line"></span><br><span class="line">const strats = Vue.config.optionMergeStrategies</span><br><span class="line">// use the same hook merging strategy for route hooks</span><br><span class="line">strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created</span><br></pre></td></tr></table></figure></li><li><p>注册RouterView和RouterLink组件</p></li></ul><h2 id="vue-router的实现"><a href="#vue-router的实现" class="headerlink" title="vue-router的实现"></a>vue-router的实现</h2><h3 id="vue-router实例-src-index-js"><a href="#vue-router实例-src-index-js" class="headerlink" title="vue-router实例 src/index.js"></a>vue-router实例 src/index.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">export default class VueRouter &#123;</span><br><span class="line">  static install: () =&gt; void;</span><br><span class="line">  static version: string;</span><br><span class="line"></span><br><span class="line">  app: any;</span><br><span class="line">  apps: Array&lt;any&gt;;</span><br><span class="line">  ready: boolean;</span><br><span class="line">  readyCbs: Array&lt;Function&gt;;</span><br><span class="line">  options: RouterOptions;</span><br><span class="line">  mode: string;</span><br><span class="line">  history: HashHistory | HTML5History | AbstractHistory;</span><br><span class="line">  matcher: Matcher;</span><br><span class="line">  fallback: boolean;</span><br><span class="line">  beforeHooks: Array&lt;?NavigationGuard&gt;;</span><br><span class="line">  resolveHooks: Array&lt;?NavigationGuard&gt;;</span><br><span class="line">  afterHooks: Array&lt;?AfterNavigationHook&gt;;</span><br><span class="line"></span><br><span class="line">  constructor (options: RouterOptions = &#123;&#125;) &#123;</span><br><span class="line">    this.app = null</span><br><span class="line">    this.apps = []</span><br><span class="line">    this.options = options</span><br><span class="line">    this.beforeHooks = []</span><br><span class="line">    this.resolveHooks = []</span><br><span class="line">    this.afterHooks = []</span><br><span class="line">    this.matcher = createMatcher(options.routes || [], this) //生成匹配表</span><br><span class="line">     // 路由模式设置默认hash</span><br><span class="line">    let mode = options.mode || &apos;hash&apos;</span><br><span class="line">    // 路由降级，如果不支持history降级到hash</span><br><span class="line">    this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false</span><br><span class="line">    if (this.fallback) &#123;</span><br><span class="line">      mode = &apos;hash&apos;</span><br><span class="line">    &#125;</span><br><span class="line">    // 非浏览器环境</span><br><span class="line">    if (!inBrowser) &#123;</span><br><span class="line">      mode = &apos;abstract&apos;</span><br><span class="line">    &#125;</span><br><span class="line">    this.mode = mode</span><br><span class="line"></span><br><span class="line">    switch (mode) &#123;</span><br><span class="line">      case &apos;history&apos;: //浏览器history模式</span><br><span class="line">        this.history = new HTML5History(this, options.base)</span><br><span class="line">        break</span><br><span class="line">      case &apos;hash&apos;: //浏览器hash模式</span><br><span class="line">        this.history = new HashHistory(this, options.base, this.fallback)</span><br><span class="line">        break</span><br><span class="line">      case &apos;abstract&apos;: //非浏览器环境</span><br><span class="line">        this.history = new AbstractHistory(this, options.base)</span><br><span class="line">        break</span><br><span class="line">      default:</span><br><span class="line">        if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">          assert(false, `invalid mode: $&#123;mode&#125;`)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="match"><a href="#match" class="headerlink" title="match"></a>match</h3><p>上文提到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.matcher = createMatcher(options.routes || [], this)</span><br></pre></td></tr></table></figure><p>我们来看看实现，src/create-matcher.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">export function createMatcher (</span><br><span class="line">  routes: Array&lt;RouteConfig&gt;,</span><br><span class="line">  router: VueRouter</span><br><span class="line">): Matcher &#123;</span><br><span class="line">  const &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</span><br><span class="line"></span><br><span class="line">  function addRoutes (routes) &#123;</span><br><span class="line">    createRouteMap(routes, pathList, pathMap, nameMap)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function match (</span><br><span class="line">    raw: RawLocation,</span><br><span class="line">    currentRoute?: Route,</span><br><span class="line">    redirectedFrom?: Location</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    const location = normalizeLocation(raw, currentRoute, false, router)</span><br><span class="line">    const &#123; name &#125; = location</span><br><span class="line"></span><br><span class="line">    if (name) &#123;</span><br><span class="line">      const record = nameMap[name]</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        warn(record, `Route with name &apos;$&#123;name&#125;&apos; does not exist`)</span><br><span class="line">      &#125;</span><br><span class="line">      if (!record) return _createRoute(null, location)</span><br><span class="line">      const paramNames = record.regex.keys</span><br><span class="line">        .filter(key =&gt; !key.optional)</span><br><span class="line">        .map(key =&gt; key.name)</span><br><span class="line"></span><br><span class="line">      if (typeof location.params !== &apos;object&apos;) &#123;</span><br><span class="line">        location.params = &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (currentRoute &amp;&amp; typeof currentRoute.params === &apos;object&apos;) &#123;</span><br><span class="line">        for (const key in currentRoute.params) &#123;</span><br><span class="line">          if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) &gt; -1) &#123;</span><br><span class="line">            location.params[key] = currentRoute.params[key]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      location.path = fillParams(record.path, location.params, `named route &quot;$&#123;name&#125;&quot;`)</span><br><span class="line">      return _createRoute(record, location, redirectedFrom)</span><br><span class="line">    &#125; else if (location.path) &#123;</span><br><span class="line">      location.params = &#123;&#125;</span><br><span class="line">      for (let i = 0; i &lt; pathList.length; i++) &#123;</span><br><span class="line">        const path = pathList[i]</span><br><span class="line">        const record = pathMap[path]</span><br><span class="line">        if (matchRoute(record.regex, location.path, location.params)) &#123;</span><br><span class="line">          return _createRoute(record, location, redirectedFrom)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // no match</span><br><span class="line">    return _createRoute(null, location)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function redirect (</span><br><span class="line">    record: RouteRecord,</span><br><span class="line">    location: Location</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    const originalRedirect = record.redirect</span><br><span class="line">    let redirect = typeof originalRedirect === &apos;function&apos;</span><br><span class="line">      ? originalRedirect(createRoute(record, location, null, router))</span><br><span class="line">      : originalRedirect</span><br><span class="line"></span><br><span class="line">    if (typeof redirect === &apos;string&apos;) &#123;</span><br><span class="line">      redirect = &#123; path: redirect &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!redirect || typeof redirect !== &apos;object&apos;) &#123;</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          false, `invalid redirect option: $&#123;JSON.stringify(redirect)&#125;`</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      return _createRoute(null, location)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const re: Object = redirect</span><br><span class="line">    const &#123; name, path &#125; = re</span><br><span class="line">    let &#123; query, hash, params &#125; = location</span><br><span class="line">    query = re.hasOwnProperty(&apos;query&apos;) ? re.query : query</span><br><span class="line">    hash = re.hasOwnProperty(&apos;hash&apos;) ? re.hash : hash</span><br><span class="line">    params = re.hasOwnProperty(&apos;params&apos;) ? re.params : params</span><br><span class="line"></span><br><span class="line">    if (name) &#123;</span><br><span class="line">      // resolved named direct</span><br><span class="line">      const targetRecord = nameMap[name]</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        assert(targetRecord, `redirect failed: named route &quot;$&#123;name&#125;&quot; not found.`)</span><br><span class="line">      &#125;</span><br><span class="line">      return match(&#123;</span><br><span class="line">        _normalized: true,</span><br><span class="line">        name,</span><br><span class="line">        query,</span><br><span class="line">        hash,</span><br><span class="line">        params</span><br><span class="line">      &#125;, undefined, location)</span><br><span class="line">    &#125; else if (path) &#123;</span><br><span class="line">      // 1. resolve relative redirect</span><br><span class="line">      const rawPath = resolveRecordPath(path, record)</span><br><span class="line">      // 2. resolve params</span><br><span class="line">      const resolvedPath = fillParams(rawPath, params, `redirect route with path &quot;$&#123;rawPath&#125;&quot;`)</span><br><span class="line">      // 3. rematch with existing query and hash</span><br><span class="line">      return match(&#123;</span><br><span class="line">        _normalized: true,</span><br><span class="line">        path: resolvedPath,</span><br><span class="line">        query,</span><br><span class="line">        hash</span><br><span class="line">      &#125;, undefined, location)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        warn(false, `invalid redirect option: $&#123;JSON.stringify(redirect)&#125;`)</span><br><span class="line">      &#125;</span><br><span class="line">      return _createRoute(null, location)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function alias (</span><br><span class="line">    record: RouteRecord,</span><br><span class="line">    location: Location,</span><br><span class="line">    matchAs: string</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    const aliasedPath = fillParams(matchAs, location.params, `aliased route with path &quot;$&#123;matchAs&#125;&quot;`)</span><br><span class="line">    const aliasedMatch = match(&#123;</span><br><span class="line">      _normalized: true,</span><br><span class="line">      path: aliasedPath</span><br><span class="line">    &#125;)</span><br><span class="line">    if (aliasedMatch) &#123;</span><br><span class="line">      const matched = aliasedMatch.matched</span><br><span class="line">      const aliasedRecord = matched[matched.length - 1]</span><br><span class="line">      location.params = aliasedMatch.params</span><br><span class="line">      return _createRoute(aliasedRecord, location)</span><br><span class="line">    &#125;</span><br><span class="line">    return _createRoute(null, location)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function _createRoute (</span><br><span class="line">    record: ?RouteRecord,</span><br><span class="line">    location: Location,</span><br><span class="line">    redirectedFrom?: Location</span><br><span class="line">  ): Route &#123;</span><br><span class="line">    if (record &amp;&amp; record.redirect) &#123;</span><br><span class="line">      return redirect(record, redirectedFrom || location)</span><br><span class="line">    &#125;</span><br><span class="line">    if (record &amp;&amp; record.matchAs) &#123;</span><br><span class="line">      return alias(record, location, record.matchAs)</span><br><span class="line">    &#125;</span><br><span class="line">    return createRoute(record, location, redirectedFrom, router)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    match,</span><br><span class="line">    addRoutes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createMatcher再一次将routes配置数组传给了createRouteMap进一步处理,<br>根据代码分析createMatcher就是根据传入的routes生成路由map对应表，并且返回match函数以及一个可以增加路由配置项addRoutes函数，向上传递给VueRouter类暴露的接口addRoutes。</p><p>下面来看下createRouteMap src/create-route-map.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">export function createRouteMap (</span><br><span class="line">  routes: Array&lt;RouteConfig&gt;,</span><br><span class="line">  oldPathList?: Array&lt;string&gt;,</span><br><span class="line">  oldPathMap?: Dictionary&lt;RouteRecord&gt;,</span><br><span class="line">  oldNameMap?: Dictionary&lt;RouteRecord&gt;</span><br><span class="line">): &#123;</span><br><span class="line">  pathList: Array&lt;string&gt;,</span><br><span class="line">  pathMap: Dictionary&lt;RouteRecord&gt;,</span><br><span class="line">  nameMap: Dictionary&lt;RouteRecord&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  // the path list is used to control path matching priority</span><br><span class="line">  const pathList: Array&lt;string&gt; = oldPathList || [] //路径列表</span><br><span class="line">  // $flow-disable-line</span><br><span class="line">  const pathMap: Dictionary&lt;RouteRecord&gt; = oldPathMap || Object.create(null) //path路由映射</span><br><span class="line">  // $flow-disable-line</span><br><span class="line">  const nameMap: Dictionary&lt;RouteRecord&gt; = oldNameMap || Object.create(null) //name路由映射</span><br><span class="line"></span><br><span class="line">  routes.forEach(route =&gt; &#123;</span><br><span class="line">    addRouteRecord(pathList, pathMap, nameMap, route)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  // ensure wildcard routes are always at the end</span><br><span class="line">  for (let i = 0, l = pathList.length; i &lt; l; i++) &#123;</span><br><span class="line">    if (pathList[i] === &apos;*&apos;) &#123;</span><br><span class="line">      pathList.push(pathList.splice(i, 1)[0])</span><br><span class="line">      l--</span><br><span class="line">      i--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (process.env.NODE_ENV === &apos;development&apos;) &#123;</span><br><span class="line">    // warn if routes do not include leading slashes</span><br><span class="line">    const found = pathList</span><br><span class="line">    // check for missing leading slash</span><br><span class="line">      .filter(path =&gt; path &amp;&amp; path.charAt(0) !== &apos;*&apos; &amp;&amp; path.charAt(0) !== &apos;/&apos;)</span><br><span class="line"></span><br><span class="line">    if (found.length &gt; 0) &#123;</span><br><span class="line">      const pathNames = found.map(path =&gt; `- $&#123;path&#125;`).join(&apos;\n&apos;)</span><br><span class="line">      warn(false, `Non-nested routes must include a leading slash character. Fix the following routes: \n$&#123;pathNames&#125;`)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    pathList,</span><br><span class="line">    pathMap,</span><br><span class="line">    nameMap</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function addRouteRecord (</span><br><span class="line">  pathList: Array&lt;string&gt;,  </span><br><span class="line">  pathMap: Dictionary&lt;RouteRecord&gt;, </span><br><span class="line">  nameMap: Dictionary&lt;RouteRecord&gt;,</span><br><span class="line">  route: RouteConfig,</span><br><span class="line">  parent?: RouteRecord,</span><br><span class="line">  matchAs?: string</span><br><span class="line">) &#123;</span><br><span class="line">  const &#123; path, name &#125; = route</span><br><span class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">    assert(path != null, `&quot;path&quot; is required in a route configuration.`)</span><br><span class="line">    assert(</span><br><span class="line">      typeof route.component !== &apos;string&apos;,</span><br><span class="line">      `route config &quot;component&quot; for path: $&#123;String(</span><br><span class="line">        path || name</span><br><span class="line">      )&#125; cannot be a ` + `string id. Use an actual component instead.`</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const pathToRegexpOptions: PathToRegexpOptions =</span><br><span class="line">    route.pathToRegexpOptions || &#123;&#125;</span><br><span class="line">  const normalizedPath = normalizePath(path, parent, pathToRegexpOptions.strict)</span><br><span class="line"></span><br><span class="line">  if (typeof route.caseSensitive === &apos;boolean&apos;) &#123;</span><br><span class="line">    pathToRegexpOptions.sensitive = route.caseSensitive</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const record: RouteRecord = &#123;</span><br><span class="line">    path: normalizedPath, //路径</span><br><span class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions), //转化为匹配数组</span><br><span class="line">    components: route.components || &#123; default: route.component &#125;, // 关联组件</span><br><span class="line">    instances: &#123;&#125;,</span><br><span class="line">    name,</span><br><span class="line">    parent, // 父级router</span><br><span class="line">    matchAs,</span><br><span class="line">    redirect: route.redirect, // 跳转</span><br><span class="line">    beforeEnter: route.beforeEnter, // 进入前操作</span><br><span class="line">    meta: route.meta || &#123;&#125;, // 附加参数</span><br><span class="line">    props:</span><br><span class="line">      route.props == null</span><br><span class="line">        ? &#123;&#125;</span><br><span class="line">        : route.components</span><br><span class="line">          ? route.props</span><br><span class="line">          : &#123; default: route.props &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> // 子路由</span><br><span class="line">  if (route.children) &#123;</span><br><span class="line">    // Warn if route is named, does not redirect and has a default child route.</span><br><span class="line">    // If users navigate to this route by name, the default child will</span><br><span class="line">    // not be rendered (GH Issue #629)</span><br><span class="line">    if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">      if (</span><br><span class="line">        route.name &amp;&amp;</span><br><span class="line">        !route.redirect &amp;&amp;</span><br><span class="line">        route.children.some(child =&gt; /^\/?$/.test(child.path))</span><br><span class="line">      ) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          false,</span><br><span class="line">          `Named Route &apos;$&#123;route.name&#125;&apos; has a default child route. ` +</span><br><span class="line">            `When navigating to this named route (:to=&quot;&#123;name: &apos;$&#123;</span><br><span class="line">              route.name</span><br><span class="line">            &#125;&apos;&quot;), ` +</span><br><span class="line">            `the default child route will not be rendered. Remove the name from ` +</span><br><span class="line">            `this route and use the name of the default child route for named ` +</span><br><span class="line">            `links instead.`</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 子路由收集</span><br><span class="line">    route.children.forEach(child =&gt; &#123;</span><br><span class="line">      const childMatchAs = matchAs</span><br><span class="line">        ? cleanPath(`$&#123;matchAs&#125;/$&#123;child.path&#125;`)</span><br><span class="line">        : undefined</span><br><span class="line">      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  // 按照路径存储</span><br><span class="line">  if (!pathMap[record.path]) &#123;</span><br><span class="line">    pathList.push(record.path)</span><br><span class="line">    pathMap[record.path] = record</span><br><span class="line">  &#125;</span><br><span class="line"> // 别名</span><br><span class="line">  if (route.alias !== undefined) &#123;</span><br><span class="line">    const aliases = Array.isArray(route.alias) ? route.alias : [route.alias]</span><br><span class="line">    for (let i = 0; i &lt; aliases.length; ++i) &#123;</span><br><span class="line">      const alias = aliases[i]</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos; &amp;&amp; alias === path) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          false,</span><br><span class="line">          `Found an alias with the same value as the path: &quot;$&#123;path&#125;&quot;. You have to remove that alias. It will be ignored in development.`</span><br><span class="line">        )</span><br><span class="line">        // skip in dev to make it work</span><br><span class="line">        continue</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const aliasRoute = &#123;</span><br><span class="line">        path: alias,</span><br><span class="line">        children: route.children</span><br><span class="line">      &#125;</span><br><span class="line">      addRouteRecord(</span><br><span class="line">        pathList,</span><br><span class="line">        pathMap,</span><br><span class="line">        nameMap,</span><br><span class="line">        aliasRoute,</span><br><span class="line">        parent,</span><br><span class="line">        record.path || &apos;/&apos; // matchAs</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">// 按照名字存储</span><br><span class="line">  if (name) &#123;</span><br><span class="line">    if (!nameMap[name]) &#123;</span><br><span class="line">      nameMap[name] = record</span><br><span class="line">    &#125; else if (process.env.NODE_ENV !== &apos;production&apos; &amp;&amp; !matchAs) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        false,</span><br><span class="line">        `Duplicate named routes definition: ` +</span><br><span class="line">          `&#123; name: &quot;$&#123;name&#125;&quot;, path: &quot;$&#123;record.path&#125;&quot; &#125;`</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要是对router进行收集，通过path和name的方式存储，以便后期匹配。</p><h3 id="vueRouter构造函数"><a href="#vueRouter构造函数" class="headerlink" title="vueRouter构造函数"></a>vueRouter构造函数</h3><p> src/history/base.js<br>定义了路由的基本属性方法<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"> export class History &#123;</span><br><span class="line">  router: Router //路由对象</span><br><span class="line">  base: string // 基准路径</span><br><span class="line">  current: Route // 当前路由</span><br><span class="line">  pending: ?Route</span><br><span class="line">  cb: (r: Route) =&gt; void</span><br><span class="line">  ready: boolean</span><br><span class="line">  readyCbs: Array&lt;Function&gt;</span><br><span class="line">  readyErrorCbs: Array&lt;Function&gt;</span><br><span class="line">  errorCbs: Array&lt;Function&gt;</span><br><span class="line"></span><br><span class="line">  // implemented by sub-classes</span><br><span class="line">  +go: (n: number) =&gt; void</span><br><span class="line">  +push: (loc: RawLocation) =&gt; void</span><br><span class="line">  +replace: (loc: RawLocation) =&gt; void</span><br><span class="line">  +ensureURL: (push?: boolean) =&gt; void</span><br><span class="line">  +getCurrentLocation: () =&gt; string</span><br><span class="line"></span><br><span class="line">  constructor (router: Router, base: ?string) &#123;</span><br><span class="line">    this.router = router</span><br><span class="line">    // normalizeBase会对base路径做出格式化的处理，会为base开头自动添加‘/’，删除结尾的‘/’，默认返回’/‘</span><br><span class="line">    this.base = normalizeBase(base)</span><br><span class="line">    // start with a route object that stands for &quot;nowhere&quot;</span><br><span class="line">    this.current = START</span><br><span class="line">    this.pending = null</span><br><span class="line">    this.ready = false</span><br><span class="line">    this.readyCbs = []</span><br><span class="line">    this.readyErrorCbs = []</span><br><span class="line">    this.errorCbs = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  listen (cb: Function) &#123;</span><br><span class="line">    this.cb = cb</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onReady (cb: Function, errorCb: ?Function) &#123;</span><br><span class="line">    if (this.ready) &#123;</span><br><span class="line">      cb()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      this.readyCbs.push(cb)</span><br><span class="line">      if (errorCb) &#123;</span><br><span class="line">        this.readyErrorCbs.push(errorCb)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onError (errorCb: Function) &#123;</span><br><span class="line">    this.errorCbs.push(errorCb)</span><br><span class="line">  &#125;</span><br><span class="line"> // 路由转化操作</span><br><span class="line">  transitionTo (</span><br><span class="line">    location: RawLocation,</span><br><span class="line">    onComplete?: Function,</span><br><span class="line">    onAbort?: Function</span><br><span class="line">  ) &#123;</span><br><span class="line">    const route = this.router.match(location, this.current) // 找到匹配的路由</span><br><span class="line">    this.confirmTransition( //确认是否转换</span><br><span class="line">      route,</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        this.updateRoute(route) // 更新路由</span><br><span class="line">        onComplete &amp;&amp; onComplete(route)</span><br><span class="line">        this.ensureURL()</span><br><span class="line"></span><br><span class="line">        // fire ready cbs once</span><br><span class="line">        if (!this.ready) &#123;</span><br><span class="line">          this.ready = true</span><br><span class="line">          this.readyCbs.forEach(cb =&gt; &#123;</span><br><span class="line">            cb(route)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      err =&gt; &#123;</span><br><span class="line">        if (onAbort) &#123;</span><br><span class="line">          onAbort(err)</span><br><span class="line">        &#125;</span><br><span class="line">        if (err &amp;&amp; !this.ready) &#123;</span><br><span class="line">          this.ready = true</span><br><span class="line">          this.readyErrorCbs.forEach(cb =&gt; &#123;</span><br><span class="line">            cb(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  confirmTransition (route: Route, onComplete: Function, onAbort?: Function) &#123;</span><br><span class="line">    const current = this.current</span><br><span class="line">    const abort = err =&gt; &#123;</span><br><span class="line">      // after merging https://github.com/vuejs/vue-router/pull/2771 we</span><br><span class="line">      // When the user navigates through history through back/forward buttons</span><br><span class="line">      // we do not want to throw the error. We only throw it if directly calling</span><br><span class="line">      // push/replace. That&apos;s why it&apos;s not included in isError</span><br><span class="line">      if (!isExtendedError(NavigationDuplicated, err) &amp;&amp; isError(err)) &#123;</span><br><span class="line">        if (this.errorCbs.length) &#123;</span><br><span class="line">          this.errorCbs.forEach(cb =&gt; &#123;</span><br><span class="line">            cb(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          warn(false, &apos;uncaught error during route navigation:&apos;)</span><br><span class="line">          console.error(err)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      onAbort &amp;&amp; onAbort(err)</span><br><span class="line">    &#125;</span><br><span class="line">        // 如果是同一个路由，不操作</span><br><span class="line">    if (</span><br><span class="line">      isSameRoute(route, current) &amp;&amp;</span><br><span class="line">      // in the case the route map has been dynamically appended to</span><br><span class="line">      route.matched.length === current.matched.length</span><br><span class="line">    ) &#123;</span><br><span class="line">      this.ensureURL()</span><br><span class="line">      return abort(new NavigationDuplicated(route))</span><br><span class="line">    &#125;</span><br><span class="line"> //钩子函数处理</span><br><span class="line">  </span><br><span class="line">    const &#123; updated, deactivated, activated &#125; = resolveQueue(</span><br><span class="line">      this.current.matched,</span><br><span class="line">      route.matched</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    const queue: Array&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">      // in-component leave guards</span><br><span class="line">      extractLeaveGuards(deactivated),</span><br><span class="line">      // global before hooks</span><br><span class="line">      this.router.beforeHooks,</span><br><span class="line">      // in-component update hooks</span><br><span class="line">      extractUpdateHooks(updated),</span><br><span class="line">      // in-config enter guards</span><br><span class="line">      activated.map(m =&gt; m.beforeEnter),</span><br><span class="line">      // async components</span><br><span class="line">      resolveAsyncComponents(activated)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    this.pending = route</span><br><span class="line">    const iterator = (hook: NavigationGuard, next) =&gt; &#123;</span><br><span class="line">      if (this.pending !== route) &#123;</span><br><span class="line">        return abort()</span><br><span class="line">      &#125;</span><br><span class="line">      try &#123;</span><br><span class="line">        hook(route, current, (to: any) =&gt; &#123;</span><br><span class="line">          if (to === false || isError(to)) &#123;</span><br><span class="line">            // next(false) -&gt; abort navigation, ensure current URL</span><br><span class="line">            this.ensureURL(true)</span><br><span class="line">            abort(to)</span><br><span class="line">          &#125; else if (</span><br><span class="line">            typeof to === &apos;string&apos; ||</span><br><span class="line">            (typeof to === &apos;object&apos; &amp;&amp;</span><br><span class="line">              (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</span><br><span class="line">          ) &#123;</span><br><span class="line">            // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</span><br><span class="line">            abort()</span><br><span class="line">            if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123;</span><br><span class="line">              this.replace(to)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              this.push(to)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            // confirm transition and pass on the value</span><br><span class="line">            next(to)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        abort(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">      const postEnterCbs = []</span><br><span class="line">      const isValid = () =&gt; this.current === route</span><br><span class="line">      // wait until async components are resolved before</span><br><span class="line">      // extracting in-component enter guards</span><br><span class="line">      const enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)</span><br><span class="line">      const queue = enterGuards.concat(this.router.resolveHooks)</span><br><span class="line">      runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">        if (this.pending !== route) &#123;</span><br><span class="line">          return abort()</span><br><span class="line">        &#125;</span><br><span class="line">        this.pending = null</span><br><span class="line">        onComplete(route)</span><br><span class="line">        if (this.router.app) &#123;</span><br><span class="line">          this.router.app.$nextTick(() =&gt; &#123;</span><br><span class="line">            postEnterCbs.forEach(cb =&gt; &#123;</span><br><span class="line">              cb()</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">// 更新路由</span><br><span class="line">  updateRoute (route: Route) &#123;</span><br><span class="line">    const prev = this.current //跳转前路由</span><br><span class="line">    this.current = route    //装备跳转路由</span><br><span class="line">    this.cb &amp;&amp; this.cb(route) //回调函数，这一步很重要，这个回调函数在index文件中注册，会更新被劫持的数据 _router</span><br><span class="line">    this.router.afterHooks.forEach(hook =&gt; &#123;</span><br><span class="line">      hook &amp;&amp; hook(route, prev)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p> 以上实现了history构造函数，定义了一些基础属性和方法，其中具体的路由实现方法，如下，需要具体的实现类去实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+go: (n: number) =&gt; void;</span><br><span class="line">+push: (loc: RawLocation) =&gt; void;</span><br><span class="line">+replace: (loc: RawLocation) =&gt; void;</span><br><span class="line">+ensureURL: (push?: boolean) =&gt; void;</span><br><span class="line">+getCurrentLocation: () =&gt; string;</span><br></pre></td></tr></table></figure><p>通过transitionTo对于路由更新的控制以及更新路由，updateRoute调用了我们在vue-router中注册的函数<br>src/index.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">history.listen(route =&gt; &#123;</span><br><span class="line">  this.apps.forEach((app) =&gt; &#123;</span><br><span class="line">    app._route = route</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这一步很重要，更新_route的值，还记得我们在install中做的操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.util.defineReactive(this, &apos;_route&apos;, this._router.history.current)</span><br></pre></td></tr></table></figure><p>Vue.util.defineReactive, 这是Vue里面观察者劫持数据的方法，劫持了_route对象，这里路由更新_route,导致了视图更新。<br>Vue中看一下defineReactive的源码, 在defineReactive, 会对_route使用Object.defineProperty劫持setter方法。set时会通知观察者</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Object.defineProperty(obj, key, &#123;</span><br><span class="line">  enumerable: true,</span><br><span class="line">  configurable: true,</span><br><span class="line">  get: function reactiveGetter () &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;,</span><br><span class="line">  set: function reactiveSetter (newVal) &#123;</span><br><span class="line">    // ...</span><br><span class="line">    childOb = !shallow &amp;&amp; observe(newVal)</span><br><span class="line">    dep.notify()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，我们来看如何调用transitionTo，达到更新目的<br>来看一下hash的实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export class HashHistory extends History &#123;</span><br><span class="line">  constructor (router: Router, base: ?string, fallback: boolean) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line">    // check history fallback deeplinking</span><br><span class="line">     // 如果是回退hash的情况，并且判断当前路径是否有/#/。如果没有将会添加&apos;/#/&apos;</span><br><span class="line">    if (fallback &amp;&amp; checkFallback(this.base)) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    ensureSlash()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>checkFallback</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 检查url是否包含‘/#/’</span><br><span class="line">function checkFallback (base) &#123;</span><br><span class="line">  // 获取hash值</span><br><span class="line">  const location = getLocation(base)</span><br><span class="line">  // 如果location不是以/#，开头。添加/#，使用window.location.replace替换文档</span><br><span class="line">  if (!/^\/#/.test(location)) &#123;</span><br><span class="line">    window.location.replace(</span><br><span class="line">      cleanPath(base + &apos;/#&apos; + location)</span><br><span class="line">    )</span><br><span class="line">    return true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 返回hash</span><br><span class="line">export function getLocation (base) &#123;</span><br><span class="line">  let path = decodeURI(window.location.pathname)</span><br><span class="line">  if (base &amp;&amp; path.indexOf(base) === 0) &#123;</span><br><span class="line">    path = path.slice(base.length)</span><br><span class="line">  &#125;</span><br><span class="line">  return (path || &apos;/&apos;) + window.location.search + window.location.hash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 删除 //, 替换为 /</span><br><span class="line">export function cleanPath (path) &#123;</span><br><span class="line">  return path.replace(/\/\//g, &apos;/&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用transitionTo</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">//hash.js</span><br><span class="line">//设置路由，监控路由改变</span><br><span class="line">export class HashHistory extends History &#123;</span><br><span class="line">  constructor (router: Router, base: ?string, fallback: boolean) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line">    // check history fallback deeplinking</span><br><span class="line">    if (fallback &amp;&amp; checkFallback(this.base)) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    ensureSlash()</span><br><span class="line">  &#125;</span><br><span class="line">  setupListeners () &#123;</span><br><span class="line">    window.addEventListener(&apos;hashchange&apos;, () =&gt; &#123;</span><br><span class="line">      if (!ensureSlash()) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      this.transitionTo(getHash(), route =&gt; &#123;</span><br><span class="line">        replaceHash(route.fullPath)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> //push方法</span><br><span class="line">  push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      pushHash(route.fullPath)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line">  //replace方法</span><br><span class="line">  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      replaceHash(route.fullPath)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">  //html5.js实现</span><br><span class="line"></span><br><span class="line">export class HTML5History extends History &#123;</span><br><span class="line">  constructor (router: Router, base: ?string) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line"></span><br><span class="line">    const expectScroll = router.options.scrollBehavior //指回滚方式</span><br><span class="line"></span><br><span class="line">    if (expectScroll) &#123;</span><br><span class="line">      setupScroll()</span><br><span class="line">    &#125;</span><br><span class="line">    //监控popstate事件</span><br><span class="line">    window.addEventListener(&apos;popstate&apos;, e =&gt; &#123;</span><br><span class="line">      const current = this.current</span><br><span class="line">      this.transitionTo(getLocation(this.base), route =&gt; &#123;</span><br><span class="line">        if (expectScroll) &#123;</span><br><span class="line">          handleScroll(router, route, current, true)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //push</span><br><span class="line">   push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      pushState(cleanPath(this.base + route.fullPath)) //保存当前的位置信息，用于返回时候复位</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      replaceState(cleanPath(this.base + route.fullPath)) //保存当前的位置信息，用于返回时候复位</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  //abstract.js实现，这里通过栈的数据结构来模拟路由路径</span><br><span class="line"> export class AbstractHistory extends History &#123;</span><br><span class="line">  index: number;</span><br><span class="line">  stack: Array&lt;Route&gt;;</span><br><span class="line"></span><br><span class="line">  constructor (router: Router, base: ?string) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line">    this.stack = []</span><br><span class="line">    this.index = -1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      this.stack = this.stack.slice(0, this.index + 1).concat(route)</span><br><span class="line">      this.index++</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      this.stack = this.stack.slice(0, this.index).concat(route)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，3种方式都提供了replace和push接口来更新路由同时hash模式监控 hashchange，H5模式监控 popstate</p><p>这里H5模式多了一步保存当前的位置信息，用于返回时候复位的操作</p><p>除了在子类调用之外，在 vueRouter类中init也有调用<br>src/index.js init</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if (history instanceof HTML5History) &#123;</span><br><span class="line">      history.transitionTo(history.getCurrentLocation())</span><br><span class="line">    &#125; else if (history instanceof HashHistory) &#123;</span><br><span class="line">      //建立hash监控</span><br><span class="line">      const setupHashListener = () =&gt; &#123;</span><br><span class="line">        history.setupListeners()</span><br><span class="line">      &#125;</span><br><span class="line">      history.transitionTo(</span><br><span class="line">        history.getCurrentLocation(),</span><br><span class="line">        setupHashListener,</span><br><span class="line">        setupHashListener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为在这hash和history模式下才有可能存在进入时候的不是默认页，需要根据当前浏览器地址栏里的 path 或者 hash 来激活对应的路由，此时就是通过调用 transitionTo 来达到目的<br>接着继续追踪replace和push的调用，这两个方法的触发通过我们定义的router-link组件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  name: &apos;RouterLink&apos;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    to: &#123;</span><br><span class="line">      type: toTypes,</span><br><span class="line">      required: true</span><br><span class="line">    &#125;,</span><br><span class="line">    tag: &#123;</span><br><span class="line">      type: String,</span><br><span class="line">      default: &apos;a&apos;</span><br><span class="line">    &#125;,</span><br><span class="line">    exact: Boolean,</span><br><span class="line">    append: Boolean,</span><br><span class="line">    replace: Boolean,</span><br><span class="line">    activeClass: String,</span><br><span class="line">    exactActiveClass: String,</span><br><span class="line">    ariaCurrentValue: &#123;</span><br><span class="line">      type: String,</span><br><span class="line">      default: &apos;page&apos;</span><br><span class="line">    &#125;,</span><br><span class="line">    event: &#123;</span><br><span class="line">      type: eventTypes,</span><br><span class="line">      default: &apos;click&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  render (h: Function) &#123;</span><br><span class="line">    const router = this.$router //路由对象</span><br><span class="line">    const current = this.$route //当前路由</span><br><span class="line">     //解析 to的路径对应路由项</span><br><span class="line">    const &#123; location, route, href &#125; = router.resolve(</span><br><span class="line">      this.to,</span><br><span class="line">      current,</span><br><span class="line">      this.append</span><br><span class="line">    )</span><br><span class="line">    //设置一些默认元素class</span><br><span class="line">    const classes = &#123;&#125;</span><br><span class="line">    const globalActiveClass = router.options.linkActiveClass</span><br><span class="line">    const globalExactActiveClass = router.options.linkExactActiveClass</span><br><span class="line">    // Support global empty active class</span><br><span class="line">    const activeClassFallback =</span><br><span class="line">      globalActiveClass == null ? &apos;router-link-active&apos; : globalActiveClass</span><br><span class="line">    const exactActiveClassFallback =</span><br><span class="line">      globalExactActiveClass == null</span><br><span class="line">        ? &apos;router-link-exact-active&apos;</span><br><span class="line">        : globalExactActiveClass</span><br><span class="line">    const activeClass =</span><br><span class="line">      this.activeClass == null ? activeClassFallback : this.activeClass</span><br><span class="line">    const exactActiveClass =</span><br><span class="line">      this.exactActiveClass == null</span><br><span class="line">        ? exactActiveClassFallback</span><br><span class="line">        : this.exactActiveClass</span><br><span class="line"></span><br><span class="line">    const compareTarget = route.redirectedFrom</span><br><span class="line">      ? createRoute(null, normalizeLocation(route.redirectedFrom), null, router)</span><br><span class="line">      : route</span><br><span class="line">    // 如果严格模式的话 就判断是否是相同路由（path query params hash）</span><br><span class="line">    // 否则就走包含逻辑（path包含，query包含 hash为空或者相同）</span><br><span class="line">    classes[exactActiveClass] = isSameRoute(current, compareTarget)</span><br><span class="line">    classes[activeClass] = this.exact</span><br><span class="line">      ? classes[exactActiveClass]</span><br><span class="line">      : isIncludedRoute(current, compareTarget)</span><br><span class="line"></span><br><span class="line">    const ariaCurrentValue = classes[exactActiveClass] ? this.ariaCurrentValue : null</span><br><span class="line">    // 点击触发事件通过push或者replace更新路由</span><br><span class="line">    const handler = e =&gt; &#123;</span><br><span class="line">      if (guardEvent(e)) &#123;</span><br><span class="line">        if (this.replace) &#123;</span><br><span class="line">          router.replace(location, noop)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          router.push(location, noop)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const on = &#123; click: guardEvent &#125;</span><br><span class="line">    if (Array.isArray(this.event)) &#123;</span><br><span class="line">      this.event.forEach(e =&gt; &#123;</span><br><span class="line">        on[e] = handler</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      on[this.event] = handler</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const data: any = &#123; class: classes &#125;</span><br><span class="line"></span><br><span class="line">    const scopedSlot =</span><br><span class="line">      !this.$scopedSlots.$hasNormal &amp;&amp;</span><br><span class="line">      this.$scopedSlots.default &amp;&amp;</span><br><span class="line">      this.$scopedSlots.default(&#123;</span><br><span class="line">        href,</span><br><span class="line">        route,</span><br><span class="line">        navigate: handler,</span><br><span class="line">        isActive: classes[activeClass],</span><br><span class="line">        isExactActive: classes[exactActiveClass]</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    if (scopedSlot) &#123;</span><br><span class="line">      if (scopedSlot.length === 1) &#123;</span><br><span class="line">        return scopedSlot[0]</span><br><span class="line">      &#125; else if (scopedSlot.length &gt; 1 || !scopedSlot.length) &#123;</span><br><span class="line">        if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            false,</span><br><span class="line">            `RouterLink with to=&quot;$&#123;</span><br><span class="line">              this.to</span><br><span class="line">            &#125;&quot; is trying to use a scoped slot but it didn&apos;t provide exactly one child. Wrapping the content with a span element.`</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        return scopedSlot.length === 0 ? h() : h(&apos;span&apos;, &#123;&#125;, scopedSlot)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.tag === &apos;a&apos;) &#123;</span><br><span class="line">      data.on = on</span><br><span class="line">      // aria-current设置当前激活页</span><br><span class="line">      </span><br><span class="line">      data.attrs = &#123; href, &apos;aria-current&apos;: ariaCurrentValue &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // find the first &lt;a&gt; child and apply listener and href</span><br><span class="line">      const a = findAnchor(this.$slots.default)</span><br><span class="line">      if (a) &#123;</span><br><span class="line">        // in case the &lt;a&gt; is a static node</span><br><span class="line">        a.isStatic = false</span><br><span class="line">        const aData = (a.data = extend(&#123;&#125;, a.data))</span><br><span class="line">        aData.on = aData.on || &#123;&#125;</span><br><span class="line">        // transform existing events in both objects into arrays so we can push later</span><br><span class="line">        for (const event in aData.on) &#123;</span><br><span class="line">          const handler = aData.on[event]</span><br><span class="line">          if (event in on) &#123;</span><br><span class="line">            aData.on[event] = Array.isArray(handler) ? handler : [handler]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // append new listeners for router-link</span><br><span class="line">        for (const event in on) &#123;</span><br><span class="line">          if (event in aData.on) &#123;</span><br><span class="line">            // on[event] is always a function</span><br><span class="line">            aData.on[event].push(on[event])</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            aData.on[event] = handler</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const aAttrs = (a.data.attrs = extend(&#123;&#125;, a.data.attrs))</span><br><span class="line">        aAttrs.href = href</span><br><span class="line">        aAttrs[&apos;aria-current&apos;] = ariaCurrentValue</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // doesn&apos;t have &lt;a&gt; child, apply listener to self</span><br><span class="line">        data.on = on</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return h(this.tag, data, this.$slots.default)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function guardEvent (e) &#123;</span><br><span class="line">  // don&apos;t redirect with control keys</span><br><span class="line">  if (e.metaKey || e.altKey || e.ctrlKey || e.shiftKey) return</span><br><span class="line">  // don&apos;t redirect when preventDefault called</span><br><span class="line">  if (e.defaultPrevented) return</span><br><span class="line">  // don&apos;t redirect on right click</span><br><span class="line">  if (e.button !== undefined &amp;&amp; e.button !== 0) return</span><br><span class="line">  // don&apos;t redirect if `target=&quot;_blank&quot;`</span><br><span class="line">  if (e.currentTarget &amp;&amp; e.currentTarget.getAttribute) &#123;</span><br><span class="line">    const target = e.currentTarget.getAttribute(&apos;target&apos;)</span><br><span class="line">    if (/\b_blank\b/i.test(target)) return</span><br><span class="line">  &#125;</span><br><span class="line">  // this may be a Weex event which doesn&apos;t have this method</span><br><span class="line">  if (e.preventDefault) &#123;</span><br><span class="line">    e.preventDefault()</span><br><span class="line">  &#125;</span><br><span class="line">  return true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//找到第一个A标签</span><br><span class="line">function findAnchor (children) &#123;</span><br><span class="line">  if (children) &#123;</span><br><span class="line">    let child</span><br><span class="line">    for (let i = 0; i &lt; children.length; i++) &#123;</span><br><span class="line">      child = children[i]</span><br><span class="line">      if (child.tag === &apos;a&apos;) &#123;</span><br><span class="line">        return child</span><br><span class="line">      &#125;</span><br><span class="line">      if (child.children &amp;&amp; (child = findAnchor(child.children))) &#123;</span><br><span class="line">        return child</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面看一下router-view<br>RouterView是可以互相嵌套的，RouterView依赖了parent.route属性，parent.route即this._routerRoot._route。<br>我们使用Vue.util.defineReactive将_router设置为响应式的。在transitionTo的回调中会更新_route, 这会触发RouteView的渲染</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  name: &apos;RouterView&apos;,</span><br><span class="line">  functional: true, //函数组件</span><br><span class="line">  props: &#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: String,</span><br><span class="line">      default: &apos;default&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  render (_, &#123; props, children, parent, data &#125;) &#123;</span><br><span class="line">    // used by devtools to display a router-view badge</span><br><span class="line">    data.routerView = true</span><br><span class="line"></span><br><span class="line">    // directly use parent context&apos;s createElement() function</span><br><span class="line">    // so that components rendered by router-view can resolve named slots</span><br><span class="line">    const h = parent.$createElement</span><br><span class="line">    const name = props.name</span><br><span class="line">    const route = parent.$route</span><br><span class="line">    const cache = parent._routerViewCache || (parent._routerViewCache = &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    // determine current view depth, also check to see if the tree</span><br><span class="line">    // has been toggled inactive but kept-alive.</span><br><span class="line">    let depth = 0</span><br><span class="line">    let inactive = false</span><br><span class="line">     // 使用while循环找到Vue的根节点, _routerRoot是Vue的根实例</span><br><span class="line">    // depth为当前的RouteView的深度，因为RouteView可以互相嵌套，depth可以帮组我们找到每一级RouteView需要渲染的组件</span><br><span class="line">    while (parent &amp;&amp; parent._routerRoot !== parent) &#123;</span><br><span class="line">      const vnodeData = parent.$vnode ? parent.$vnode.data : &#123;&#125;</span><br><span class="line">      if (vnodeData.routerView) &#123;</span><br><span class="line">        depth++</span><br><span class="line">      &#125;</span><br><span class="line">      if (vnodeData.keepAlive &amp;&amp; parent._directInactive &amp;&amp; parent._inactive) &#123;</span><br><span class="line">        inactive = true</span><br><span class="line">      &#125;</span><br><span class="line">      parent = parent.$parent</span><br><span class="line">    &#125;</span><br><span class="line">    data.routerViewDepth = depth</span><br><span class="line"></span><br><span class="line">    // render previous view if the tree is inactive and kept-alive</span><br><span class="line">    if (inactive) &#123;</span><br><span class="line">      const cachedData = cache[name]</span><br><span class="line">      const cachedComponent = cachedData &amp;&amp; cachedData.component</span><br><span class="line">      if (cachedComponent) &#123;</span><br><span class="line">        // #2301</span><br><span class="line">        // pass props</span><br><span class="line">        if (cachedData.configProps) &#123;</span><br><span class="line">          fillPropsinData(cachedComponent, data, cachedData.route, cachedData.configProps)</span><br><span class="line">        &#125;</span><br><span class="line">        return h(cachedComponent, data, children)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // render previous empty view</span><br><span class="line">        return h()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const matched = route.matched[depth]</span><br><span class="line">    const component = matched &amp;&amp; matched.components[name]</span><br><span class="line"></span><br><span class="line">    // render empty node if no matched route or no config component</span><br><span class="line">    if (!matched || !component) &#123;</span><br><span class="line">      cache[name] = null</span><br><span class="line">      return h()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // cache component</span><br><span class="line">    cache[name] = &#123; component &#125;</span><br><span class="line"></span><br><span class="line">    // attach instance registration hook</span><br><span class="line">    // this will be called in the instance&apos;s injected lifecycle hooks</span><br><span class="line">    data.registerRouteInstance = (vm, val) =&gt; &#123;</span><br><span class="line">      // val could be undefined for unregistration</span><br><span class="line">      const current = matched.instances[name]</span><br><span class="line">      if (</span><br><span class="line">        (val &amp;&amp; current !== vm) ||</span><br><span class="line">        (!val &amp;&amp; current === vm)</span><br><span class="line">      ) &#123;</span><br><span class="line">        matched.instances[name] = val</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // also register instance in prepatch hook</span><br><span class="line">    // in case the same component instance is reused across different routes</span><br><span class="line">    ;(data.hook || (data.hook = &#123;&#125;)).prepatch = (_, vnode) =&gt; &#123;</span><br><span class="line">      matched.instances[name] = vnode.componentInstance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // register instance in init hook</span><br><span class="line">    // in case kept-alive component be actived when routes changed</span><br><span class="line">    data.hook.init = (vnode) =&gt; &#123;</span><br><span class="line">      if (vnode.data.keepAlive &amp;&amp;</span><br><span class="line">        vnode.componentInstance &amp;&amp;</span><br><span class="line">        vnode.componentInstance !== matched.instances[name]</span><br><span class="line">      ) &#123;</span><br><span class="line">        matched.instances[name] = vnode.componentInstance</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const configProps = matched.props &amp;&amp; matched.props[name]</span><br><span class="line">    // save route and configProps in cachce</span><br><span class="line">    if (configProps) &#123;</span><br><span class="line">      extend(cache[name], &#123;</span><br><span class="line">        route,</span><br><span class="line">        configProps</span><br><span class="line">      &#125;)</span><br><span class="line">      fillPropsinData(component, data, route, configProps)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return h(component, data, children)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fillPropsinData (component, data, route, configProps) &#123;</span><br><span class="line">  // resolve props</span><br><span class="line">  let propsToPass = data.props = resolveProps(route, configProps)</span><br><span class="line">  if (propsToPass) &#123;</span><br><span class="line">    // clone to prevent mutation</span><br><span class="line">    propsToPass = data.props = extend(&#123;&#125;, propsToPass)</span><br><span class="line">    // pass non-declared props as attrs</span><br><span class="line">    const attrs = data.attrs = data.attrs || &#123;&#125;</span><br><span class="line">    for (const key in propsToPass) &#123;</span><br><span class="line">      if (!component.props || !(key in component.props)) &#123;</span><br><span class="line">        attrs[key] = propsToPass[key]</span><br><span class="line">        delete propsToPass[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function resolveProps (route, config) &#123;</span><br><span class="line">  switch (typeof config) &#123;</span><br><span class="line">    case &apos;undefined&apos;:</span><br><span class="line">      return</span><br><span class="line">    case &apos;object&apos;:</span><br><span class="line">      return config</span><br><span class="line">    case &apos;function&apos;:</span><br><span class="line">      return config(route)</span><br><span class="line">    case &apos;boolean&apos;:</span><br><span class="line">      return config ? route.params : undefined</span><br><span class="line">    default:</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          false,</span><br><span class="line">          `props in &quot;$&#123;route.path&#125;&quot; is a $&#123;typeof config&#125;, ` +</span><br><span class="line">          `expecting an object, function or boolean.`</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>安装插件<br>完成了router-link和 router-view 两个组件的注册，router-link用于触发路由的变化，router-view作为功能组件，用于触发对应路由视图的变化<br>　混入beforeCreate生命周期处理，初始化_routerRoot，_router，_route等数据<br>　全局设置VUE静态访问$router和$route，方便后期访问</li><li>根据路由配置生成router实例<br>根据配置数组生成路由配置记录表<br>　生成监控路由变化的hsitory对象</li><li>将router实例传入根VUE实例<br>根据beforeCreate混入，为根vue对象设置了劫持字段_route，用户触发router-view的变化<br>　调用init()函数，完成首次路由的渲染，首次渲染的调用路径是 调用history.transitionTo方法，根据router的match函数，生成一个新的route对象，<br>接着通过confirmTransition对比一下新生成的route和当前的route对象 是否改变，改变的话触发updateRoute，更新hsitory.current属性，触发根组件的_route的变化,<br>从而导致组件的调用render函数，更新router-view。<br>　另外一种更新路由的方式是主动触发，router-link绑定了click方法，触发history.push或者history.replace,从而触发history.transitionTo<br>　同时会监控hashchange和popstate来对路由变化作对用的处理</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/VUE/" rel="tag"><i class="fa fa-tag"></i> # VUE</a><a href="/tags/vue-router/" rel="tag"><i class="fa fa-tag"></i> # vue-router</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/03/23/HOC/" rel="next" title="VUE HOC 小结"><i class="fa fa-chevron-left"></i> VUE HOC 小结</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2020/04/03/divCenter/" rel="prev" title="div垂直水平居中，CSS2与CSS3实现">div垂直水平居中，CSS2与CSS3实现<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/xiaomai.gif" alt="SherryJiang"><p class="site-author-name" itemprop="name">SherryJiang</p><div class="site-description motion-element" itemprop="description"></div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/SherryJiang1130" title="GitHub &rarr; https://github.com/SherryJiang1130" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:13501579071@163.com" title="E-Mail &rarr; mailto:13501579071@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://example.com" title="http://example.com" rel="noopener" target="_blank">Title</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vue的第三方插件的install函数"><span class="nav-number">2.</span> <span class="nav-text">vue的第三方插件的install函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vue-router的实现"><span class="nav-number">3.</span> <span class="nav-text">vue-router的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vue-router实例-src-index-js"><span class="nav-number">3.1.</span> <span class="nav-text">vue-router实例 src/index.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#match"><span class="nav-number">3.2.</span> <span class="nav-text">match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vueRouter构造函数"><span class="nav-number">3.3.</span> <span class="nav-text">vueRouter构造函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">SherryJiang</span></div><div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.2</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.1.2"></script><script src="/js/motion.js?v=7.1.2"></script><script src="/js/affix.js?v=7.1.2"></script><script src="/js/schemes/pisces.js?v=7.1.2"></script><script src="/js/scrollspy.js?v=7.1.2"></script><script src="/js/post-details.js?v=7.1.2"></script><script src="/js/next-boot.js?v=7.1.2"></script></body></html>